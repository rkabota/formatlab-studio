{
  "name": "FormatLab - Generate Images (FIBO)",
  "nodes": [
    {
      "parameters": {
        "path": "generate",
        "responseMode": "responseNode",
        "responseData": "noData",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// Build FIBO generation request\nconst baseScene = $input.first().json.base_scene;\nconst seed = $input.first().json.seed || Math.floor(Math.random() * 100000);\nconst numVariants = $input.first().json.num_variants || 1;\n\n// Build natural language prompt from scene\nconst prompt = `\nSubject: ${baseScene.subject?.description || 'Professional scene'}\nStyle: ${baseScene.subject?.style || 'photorealistic'}\nCamera: ${baseScene.camera?.lens_mm}mm lens, ${baseScene.camera?.fov}° FOV\nLighting: \n  - Key light: ${baseScene.lighting?.key?.intensity * 100}% intensity at ${baseScene.lighting?.key?.angle}°, ${baseScene.lighting?.key?.color}\n  - Fill light: ${baseScene.lighting?.fill?.intensity * 100}% intensity\n  - Rim light: ${baseScene.lighting?.rim?.intensity * 100}% intensity\nColor: ${baseScene.color?.palette?.join(', ')}\nEffects: vignette ${baseScene.effects?.vignette || 0}%, grain ${baseScene.effects?.filmGrain || 0}%\n`.trim();\n\nreturn {\n  run_id: require('crypto').randomUUID(),\n  base_scene: baseScene,\n  seed: seed,\n  num_variants: numVariants,\n  prompt: prompt,\n  variant_seeds: Array.from({length: numVariants}, (_, i) => seed + i),\n  image_urls: []\n};"
      },
      "id": "prepare_generation",
      "name": "Prepare Generation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "loopData": {
          "mode": "iterations",
          "iterations": "={{ $node.prepare_generation.json.num_variants }}"
        },
        "options": {}
      },
      "id": "loop_variants",
      "name": "Loop Variants",
      "type": "n8n-nodes-base.loop",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.bria.ai/fibo/generate",
        "authentication": "genericCredentialType",
        "genericCredentials": {
          "authenticationType": "headerAuth",
          "genericAuth": {
            "httpHeaderAuth_header": "api_token",
            "httpHeaderAuth_credentials": "{{ $vars.FIBO_API_KEY }}"
          }
        },
        "sendHeaders": true,
        "contentType": "application/json",
        "body": "{\n  \"prompt\": \"{{ $node.prepare_generation.json.prompt }}\",\n  \"seed\": {{ $node.prepare_generation.json.variant_seeds[$execution.loopIndex] || 0 }},\n  \"sync\": false,\n  \"num_images\": 1,\n  \"negative_prompt\": \"blurry, distorted, low quality, watermark\"\n}",
        "options": {
          "response": {
            "neverError": true
          }
        }
      },
      "id": "submit_fibo_request",
      "name": "Submit FIBO Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "functionCode": "// Poll FIBO API for generation status\nconst requestId = $input.first().json.request_id;\nconst fiboApiKey = process.env.FIBO_API_KEY;\nlet status = 'IN_PROGRESS';\nlet imageUrl = null;\nlet attempts = 0;\nconst maxAttempts = 120; // 2 minutes with 1-second polling\n\nwhile (status === 'IN_PROGRESS' && attempts < maxAttempts) {\n  attempts++;\n  \n  const response = await fetch(`https://api.bria.ai/fibo/status/${requestId}`, {\n    method: 'GET',\n    headers: {\n      'api_token': fiboApiKey\n    }\n  });\n  \n  const result = await response.json();\n  status = result.status;\n  imageUrl = result.image_url;\n  \n  if (status === 'IN_PROGRESS') {\n    // Wait 1 second before next poll\n    await new Promise(resolve => setTimeout(resolve, 1000));\n  }\n}\n\nif (status !== 'COMPLETED') {\n  throw new Error(`FIBO generation failed: ${status}`);\n}\n\nreturn {\n  request_id: requestId,\n  status: status,\n  image_url: imageUrl,\n  variant_index: $execution.loopIndex,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "poll_fibo_status",
      "name": "Poll FIBO Status",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "{{ $node.submit_fibo_request.json.image_url }}",
        "options": {
          "response": {
            "responseFormat": "arraybuffer"
          }
        }
      },
      "id": "download_image",
      "name": "Download Image",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "functionCode": "// Store image in n8n and collect URLs\nconst allResults = $input.all();\nconst imageUrls = allResults.map((item, idx) => ({\n  index: idx,\n  url: item.json.image_url,\n  variant_seed: item.json.variant_seed\n}));\n\nreturn {\n  run_id: $node.prepare_generation.json.run_id,\n  base_scene: $node.prepare_generation.json.base_scene,\n  seed: $node.prepare_generation.json.seed,\n  num_variants: $node.prepare_generation.json.num_variants,\n  output_urls: imageUrls,\n  timestamp: new Date().toISOString(),\n  status: 'completed'\n};"
      },
      "id": "collect_outputs",
      "name": "Collect Outputs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "respondWithData": true
      },
      "id": "respond_generate",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 300]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "prepare_generation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_generation": {
      "main": [
        [
          {
            "node": "loop_variants",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "loop_variants": {
      "main": [
        [
          {
            "node": "submit_fibo_request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "submit_fibo_request": {
      "main": [
        [
          {
            "node": "poll_fibo_status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "poll_fibo_status": {
      "main": [
        [
          {
            "node": "download_image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "download_image": {
      "main": [
        [
          {
            "node": "collect_outputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "collect_outputs": {
      "main": [
        [
          {
            "node": "respond_generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "saveManualExecutions": true,
    "executionOrder": "v1"
  }
}
